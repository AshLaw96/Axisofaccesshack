{% extends "base.html" %}

{% load static %}
{% block content %}
<div class="container py-4">
    <!-- Show a message for logged-out users -->
    {% if not user.is_authenticated %}
    <div class="alert alert-info text-center">
        Please <a href="{% url 'account_login' %}">Log in</a> as either a Care Giver or End User to access the
        dashboard.
    </div>
    {% else %}
    <!-- Show a message for logged-in caregivers -->
    {% if user.userprofile.role == "CG" %}
    <div class="alert alert-warning text-center my-3">
        You are currently logged in as a caregiver. You will be unable to interact with the icons below.
        You can manage the icons displayed to the enduser in your <a href="{% url 'user_profile' %}">profile</a> page.
    </div>
    {% endif %}
    {% endif %}

    <!-- Favorites Button (only for logged-in users) -->
    {% if user.is_authenticated %}
    <div class="text-center mb-1 mt-4">
        <button type="button" class="btn fave-btn" data-bs-toggle="modal" data-bs-target="#favoritesModal">
            <i class="fas fa-star"></i>
        </button>
    </div>
    {% endif %}

    <!-- Groups Section (only for logged-in users) -->
    {% if user.is_authenticated and groups %}
    <div class="mb-4">
        <h2>Groups</h2>
        <div class="row">
            {% for group in groups %}
            <div class="col-md-3 mb-3">
                <button class="btn group-btn w-100 " data-bs-toggle="modal"
                    data-bs-target="#groupModal-{{ group.id }}">
                    {{ group.name }}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Icons Section -->
    <div class="row flex-wrap justify-content-center ">
        {% for icon in icons %}
        <div class="icons-wrapper col-6 col-sm-6 col-md-3 my-3"
            {% if user.is_authenticated and user.userprofile.role == "EU" %} onclick="iconClicked(this)" {% endif %}
            data-icon-id="{{ icon.id }}">
            <button class="icon-tile btn" {% if user.is_authenticated and user.userprofile.role == "EU" %} type="button"
                {% else %} disabled {% endif %}>
                <img src="{{ icon.image.url }}" alt="{{ icon.name }}" class="img-fluid">
                <p class="mt-3">{{ icon.name }}</p>
            </button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Include Modals -->
{% include "communication/index_modals.html" %}

<script>
    function iconClicked(button) {
        console.log("Tile clicked:", button);

        const allCards = document.querySelectorAll('.icons-wrapper');
        const isAlreadyEnlarged = button.classList.contains('enlarged');

        // Remove "enlarged" class from all cards except the clicked one
        allCards.forEach((card) => {
            if (card !== button) {
                card.classList.remove('enlarged');
            }
        });

        // If the card is already enlarged, minimize it (no notification)
        if (isAlreadyEnlarged) {
            button.classList.remove('enlarged');
            console.log("Tile minimized: no notification sent.");
            return;
        }

        // Enlarge the clicked card and send a notification
        const beep = new Audio("{% static 'beep.mp3' %}");
        beep.play();

        button.classList.add('enlarged');
        console.log("Tile expanded: sending notification.");

        // Send notification to the server
        const iconId = button.getAttribute('data-icon-id');
        sendNotification(iconId);
    }

    function sendNotification(iconId) {
        const url = `{% url 'send_notification' 0 %}`.replace('0', iconId);
        console.log("Sending notification to URL:", url);

        fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    console.log('Success:', data.message);
                } else {
                    console.error('Error:', data.error);
                }
            })
            .catch(error => {
                console.error('Unexpected error:', error);
            });
    }
</script>
{% endblock %}